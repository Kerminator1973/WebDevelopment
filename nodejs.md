# Что такое Node.js. Особенности

Рекомендация к прочтению: "Node.js Design Patterns" by Mario Casciaro, Luciano Mammino.

## Философия Node.js

Значительная часть философии Node.js зафиксировал её создатель - Ryan Dahl. Зафиксирована вот здесь: https://en.wikipedia.org/wiki/List_of_software_development_philosophies

Основные идеи:

**Маленькое ядро** имеет наименьшее из возможных множество функциональных возможностей, оставляя остальное т.н. userland/userspace - экосистеме модулей, живущих вне ядра. Именно этот принцип оказывает огромное влияние на культуру Node.js, предоставляя сообществу свободу экспериментирования и быстрого развития экосистемы. Сохранение функциональности ядра на самом минимуме, является не только удобным для сопровождения продукта, но и оказывает положительное культурное влияние на эволюцию всей экосистемы.

**Маленькие модули**. Модуль имеет фундаментальное згачение в структуре кода программы. Это кирпичик для содания приложений и повторно используемых ,библиотек, называемых **packages**. Один из главных принципов дизайна в Node.js состоит в том, чтобы создавать маленькие модули, не только в терминах размера, но и в терминах **scope**. Принцип повторяет ключевой принцип философии Unix:

- Small is beautiful
- Make each program do one thing well

В npm каждый установленный package имеет своё собственное подмножество зависимостей (set of dependencies), что позволят избегать конфликтов модулей. Благодаря этому возникает беспрецендентный уровень повторного использования компонентов. Хотя такой подход кажется непрактичным из-за большого объёма зависимостей, на практике это приводит к тому, что сложно найти npm package, содержащий более 100 строк кода.

Вот почему важно сохранять маленький размер модулей:

- проще понимать и использовать
- проще тестировать и сопровождать
- отлично можно использовать и в браузере

Всё это выводит принцип Don't repeat yourself (DRY) на новый уровень.

**Small surface area**: модули в Node.js обычно имеют минимальный набор функций. Это приводит к тому, что гораздо проще понять, как использовать такой модуль.

Типовой pattern в Node.js состоит в том, что модуль реализует только одну часть функциональности, например, функцию, или конструктор, предоставляя другим модулям возможность реализовать другие особенности. Это помогает пользователям понимать, что важно, а что не очень важно в конкретной задаче.

Ещё одна характеристика Node.js состоит в том, что модули создаются для использования, а не для расширения. Тот факт, что по сути, в Node.js возможность расширения является заблокированной, кажется очень не гибким, но на практике это приводит к уменьшению прецедентов использования, упрощению реализации и споровождении, а также к увеличению usability.

**Простота и прагматизм**: ключевой принцип - Keep It Simple, Stupid (KISS).

"Simplicity is the ultimate sophistication" - Leonardo da Vinci.

## The Reactor Pattern

Ключевой компонент Node.js - **synchronous event demultiplexer** (также известный как **event notification interface**). Он следит за выполнение блокирующих операций ввода/вывода и когда какая-нибудь из них (или несколько) завершается, event demultiplexer завершается и множество событий обрабатывается. В этот момент, все ресурсы, связанные с событиями возвращёнными из event demultiplexer могут быть успешно отработаны. После отработки событий (это называется **event loop**), управление снова передаётся demultiplexer-у, который снова отслеживает заданное подмножество ресурсов.

Этот подход позволяет использовать только один поток исполнения (thread) для выполнения параллельных задач, связанных с использованием I/O ресурсов. Но самое главное, этот подход позволяет реализовать модель программирования, в которой не требуется тратить вычислительные ресурсы на межпоточную синхронизацию, которая обычно обходится очень дорого.

Идея **the reactor pattern** состоит в том, что для каждой операции ввода/вывода есть обработчик, который называется **callback**. Соответственно, задача состоит в том, чтобы реагировать на завершение операции ввода/вывода передачей сообщения в связанный с этой операцией обработчик.

Связанные термины: **Event Loop** и **Event Queue**.

По сути, главная идея The Reactor Pattern состоит в том, что отсутствуют издержки на создание потоков, переключение между ними и на межпоточную синхронизацию.

## Libuv

В каждой операционной системе есть свой собственный механизм для event demultiplexer: **epoll** в Linux, **kqueue** в macOS и I/O completion port (IOCP) API в Windows. Однако, в разных операционных системах существуют фундаментальные различия, в реализации операций ввода/вывода. Так, например, обычная файловая система в Linux не поддерживает non-blocking операции и, как результат non-blocking поведение приходится реализовывать в отдельном потоке вне event loop.

Для устронения подобных различий потребовалось реализовать вывокоуровневую абстрацию для event demultiplexer. Именно эту задачу и решила команда Node.js разработав библиотеку **libuv**, портированную на все основные операционные системы. Пожалуй, именно эта библиотека является наиболее важной особенностью Node.js.

Рекомендуется к прочтению книга [An Introduction to libuv](https://nikhilm.github.io/uvbook/An%20Introduction%20to%20libuv.pdf) by _Nikhil Marathe_.
