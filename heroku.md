# Важность Heroku для разработчика

Ключевая особенность облачного сервиса [Heroku](https://www.heroku.com/) состоит в том, что запуск сервиса в работу осуществляется публикацией репозитария проекта на определённый URL, используя протокол git. Это обеспечивает очень низкий порог вхождения для запуска web-приложения в публичный доступ. Фактически, вы создаёте ваше web-приложение локально, а затем выполняете commit в remote repo и Heroku выполняет все необходимые работы по развертыванию приложения (deploy). В варианте от Heroku, развертывание приложения выполняется одной командой: `git push heroku master` из подкаталога с исходными текстами проекта своего персонального компьютера. Не нужно думать ни о безопасности, ни о сертификатах - просто сервис появляется в облаке и становится доступен для других пользователей.

## Что нужно сделать с проектом Node.js для совместимости с Heroku

Heroku использует package.json в качестве инструкции по развертыванию нашего приложения. Чтобы инструкция была полной, необходимо внести некоторые изменения.

Поскольку Heroku запускает скрипт командой `npm run start` нам необходимо добавить команду в раздел "scripts":

```
{
	...
	"scripts": {
		"start": "node src/app.js"
	}
	...
}
```

При запуске сервера Express, необходимо использовать номер порта выделенный нашему приложению сервисом Heroku:

```javascript
const port = process.env.PORT || 3000
...
app.listen(port, () => {
	console.log('The app started at ' + port)
})
```

Кроме этого, все ссылки со статических страниц должны быть локальными. Это относится и к асинхронным запросам:

```javascript
fetch('/weather?address=' + ...
```

## Ограничения Heroku

Бесплатный тарифный план сильно ограничен в части использования баз данных. Бесплатно доступно только 10 тыс. записей/месяц - этого достаточно только для демонстрационных целей, тогда как разработка должна вестись на персональном компьютере.

Приложение в бесплатном плане автоматически останавливается через 30 минут бездействия, а на повторный запуск требуется время.

Регистрация по почтовому адресу xxx@mail.ru запрещена.

## Командная строка

Управлять настройками приложения в облаке Heroku можно используя командную строку. Для этого необходимо загрузить [Heroku Toolbelt](https://devcenter.heroku.com/articles/heroku-cli).

Создание приложения Heroku:

```
heroku create [имя]
```

Когда выбирается имя приложения – оно должно быть уникальным среди всех приложений Heroku, т.е. рекомендуется использовать имя разработчика/название компании в качестве префикса. Если всё OK, то в консоль нам выводятся адрес нашего сайта и адрес git-репозитария для сохранения кода.

Если нам нужно связать уже существующее Heroku приложение с кодом из текущего локального репозитария, то можно воспользоваться командой:

```
git remote add heroku git@heroku.com:project.git
```

Тоже самое можно сделать посредством Heroku CLI:

```
heroku git:remote -a [имя вашего проекта в облаке Heroku]
```

Чтобы задать переменные окружения следует воспользоваться следующей командой:

```
heroku config:set key=value
```

Посмотреть полный список ключей можно командой:

```
heroku config
```

Удалить переменную окружения можно так:

```
heroku config:unset key
```

Типовые переменные окружения: 

1. секретное слово для JWT
2. адрес подключения к базе данных
3. API-ключи для различных облачных сервисов

Для публикации проекта на сервере Heroku следует выполнить команду:

```
git push heroku master
```

## Procfile (устаревший подход)

В инструкциях по развертыванию приложений в облаке Heroku иногда указывается на необходимость использования файла **Procfile**. В этом файле содержится команда запуска приложения после его развертывания в облаке. Содержимым этого файла может быть: `web: node index.js`. 

В действительности, для проектов Node.js [необходимости в этом файле уже нет](https://devcenter.heroku.com/changelog-items/370), достаточно указать команду запуска приложения в "package.json":

```json
{
	"scripts": {
		"start": "node src/app.js",
		"dev": "nodemon src/app.js -e js,hbs"
	}
}
```

В проект может быть включен файл-компаньён «.env», в котором указывается режим работы приложения. Пример содержимого: `NODE_ENV=production`. Указанное значение можно использовать непосредственно в JavaScript-коде:

```javascript
const isProd = process.env.NODE_ENV === "production";
```
